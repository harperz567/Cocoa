<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no,minimal-ui">
    <title>Cocoa</title>
    <link rel="icon" href="images/favico.ico">
    <!--不同屏幕尺寸根字体设置-->
    <script src="./js/base.js"></script>
    <!--element-ui的样式-->
    <link rel="stylesheet" href="../backend/plugins/element-ui/index.css" />
    <!--引入vant样式-->
    <link rel="stylesheet" href="styles/vant.min.css"/>
    <!-- 引入样式  -->
    <link rel="stylesheet" href="styles/index.css" />
    <!--本页面内容的样式-->
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
    <div id="main" class="app">
      <div class="divHead">
        <img src="./images/user.png" @click="toUserPage"/>
      </div>
      <div class="divTitle">
        <div class="divStatic">
          <img src="./images/logo_square.jpg"  class="logo"/>
          <div class="divDesc">
            <div class="divName">Cocoa</div>
            <div class="divSend">
                <span><img src="./images/paw_logo.png"/> Smart Match Recommendations</span>
                <span><img src="./images/paw_logo.png"/> Detailed Pet Information</span>
                <span><img src="./images/paw_logo.png"/> Easy Application</span>
            </div>
          </div>
        </div>
        <div class="divDesc">
          Cocoa is a great animal shelter management system!
        </div>
      </div>
      <div class="divBody">
        <div class="divType">
          <ul>
            <li v-for="(item,index) in categoryList" :key="index" @click="categoryClick(index,item.id,item.type)" :class="{active:activeType === index}">{{item.name}}</li>
          </ul>
        </div>
        <div class="divMenu">
          <div>
            <div class="divItem" v-for="(item,index) in petList" :key="index" @click="petDetails(item)">
              <el-image :src="imgPathConvert(item.image)" >
                <div slot="error" class="image-slot">
                  <img src="./images/noImg.png"/>
                </div>
              </el-image>
              <div>
                <div class="divName">{{item.name}}</div>
                <div class="divDesc">{{item.description}}</div>
<!--                <div class="divDesc">{{'月销' + (item.saleNum ? item.saleNum : 0)  }}</div>-->
                <div class="divBottom"><span>￥</span><span>{{item.price/100}}</span></div>
                <div class="divNum">
                  <div class="divSubtract" v-if="item.number > 0">
                    <img src="./images/subtract.png" @click.prevent.stop="subtractCart(item)"/>
                  </div>
                  <div class="divPetNum">{{item.number}}</div>
                  <div class="divTypes" v-if="item.details && item.details.length > 0 && !item.number " @click.prevent.stop="chooseDetailClick(item)">选择规格</div>
                  <div class="divAdd" v-else>
                    <img src="./images/add.png" @click.prevent.stop="addCart(item)"/>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="divLayer">
        <div class="divLayerLeft"></div>
        <div class="divLayerRight"></div>
      </div>
      <div class="divCart" v-if="categoryList.length > 0">
          <div :class="{imgCartActive: cartData && cartData.length > 0, imgCart:!cartData || cartData.length<1}" @click="openCart"></div>
          <div :class="{divGoodsNum:1===1, moreGoods:cartData && cartData.length > 99}" v-if="cartData && cartData.length > 0">{{ goodsNum }}</div>
          <div class="divNum">
              <span>￥</span>
              <span>{{goodsPrice}}</span>
          </div>
          <div class="divPrice"></div>
          <div :class="{btnSubmitActive: cartData && cartData.length > 0, btnSubmit:!cartData || cartData.length<1}" @click="toAddOrderPage">去结算</div>
        </div>
        <van-dialog v-model="dialogDetail.show" :show-confirm-button="false" class="dialogDetail" ref="detailDialog">
          <div class="dialogTitle">{{dialogDetail.name}}</div>
          <div class="divContent">
            <div v-for="detail in dialogDetail.details" :key="detail.id">
                <div class="divDetailTitle">{{detail.name}}</div>
                <span v-for="item in JSON.parse(detail.value)"
                :key="item"  
                @click="detailClick(detail,item)"
                :class="{spanActive:detail.petDetail === item}"
                >{{item}}</span>
            </div>
          </div>
          <div class="divBottom">
            <div><span class="spanMoney">￥</span>{{dialogDetail.price/100}}</div>
            <div @click="dialogDetailAddCart">加入购物车</div>
          </div>
          <div class="divDetailClose" @click="dialogDetail.show = false">
            <img src="./images/close.png"/>
          </div>
        </van-dialog>
        <van-popup v-model="cartDialogShow" position="bottom" :style="{ height: '50%' }" class="dialogCart">
          <div class="divCartTitle">
            <div class="title">购物车</div>
            <div class="clear" @click="clearCart">
              <i class="el-icon-delete"></i> 清空
            </div>
          </div>
          <div class="divCartContent">
            <div v-for="item in cartData" :key="item.id" class="divCartItem">
              <el-image :src="imgPathConvert(item.image)" >
                <div slot="error" class="image-slot">
                  <img src="./images/noImg.png"/>
                </div>
              </el-image>
              <div class="divDesc">
                <div class="name">{{item.name}}</div>
                <div class="price">
                  <span class="spanMoney">￥</span>{{item.amount}}</div>
              </div>
              <div class="divNum">
                <div class="divSubtract">
                  <img src="./images/subtract.png" @click="cartNumberSubtract(item)"/>
                </div>
                <div class="divPetNum">{{item.number}}</div>
                <div class="divAdd">
                  <img src="./images/add.png" @click="cartNumAdd(item)"/>
                </div>
              </div>
              <div class="divSplit"></div>
              </div>
          </div>
        </van-popup>
        <van-dialog v-model="detailsDialog.show" 
                    :show-confirm-button="false" 
                    class="detailsDialog" 
                    ref="detailsDialog"
                    v-if="detailsDialog.show"
                    >
          <div class="divContainer">
            <el-image :src="imgPathConvert(detailsDialog.item.image)" >
              <div slot="error" class="image-slot">
                <img src="./images/noImg.png"/>
              </div>
            </el-image>
            <div class="title">{{detailsDialog.item.name}}</div>
            <div class="content">{{detailsDialog.item.description}}</div>
          </div>
          <div class="divNum">
            <div class="left">
              <span>￥</span><span>{{detailsDialog.item.price/100}}</span>
            </div>
            <div class="right">
                <div class="divSubtract" v-if="detailsDialog.item.number > 0">
                  <img src="./images/subtract.png" @click="subtractCart(detailsDialog.item)"/>
                </div>
                <div class="divPetNum">{{detailsDialog.item.number}}</div>
                <div class="divTypes" v-if="detailsDialog.item.details && detailsDialog.item.details.length > 0 && !detailsDialog.item.number " @click ="chooseDetailClick(detailsDialog.item)">选择规格</div>
                <div class="divAdd" v-else>
                  <img src="./images/add.png" @click="addCart(detailsDialog.item)"/>
                </div>
            </div>
          </div>
          <div class="detailsDialogClose" @click="detailsDialog.show = false">
            <img src="./images/close.png"/>
          </div>
        </van-dialog>
        <van-dialog v-model="setPairDialog.show"
                    :show-confirm-button="false" 
                    class="setPairDetailsDialog"
                    ref="setPairDetailsDialogd"
                    v-if="setPairDialog.show"
                    >
          <div class="divContainer">
            <div class="title">{{setPairDialog.item.name}}</div>
              <div class="item" v-for="(item,index) in setPairDialog.item.list" :key="index">
                <el-image :src="imgPathConvert(item.image)">
                  <div slot="error" class="image-slot">
                    <img src="./images/noImg.png"/>
                  </div>
                </el-image>
                <div class="divSubTitle">{{item.name + '(' + item.copies + '份)' }}
                  <div class="divPrice">
                    <span>￥</span><span>{{item.price/100}}</span>
                  </div>
                </div>                
                <div class="content">{{item.description}}</div>
              </div>
            </div>
          <div class="divNum">
              <div class="left">
                <span>￥</span><span>{{setPairDialog.item.price/100}}</span>
              </div>
              <div class="right">
                  <div class="divSubtract" v-if="setPairDialog.item.number > 0">
                    <img src="./images/subtract.png" @click="subtractCart(setPairDialog.item)"/>
                  </div>
                  <div class="divPetNum">{{setPairDialog.item.number}}</div>
                  <div class="divAdd" v-if="setPairDialog.item.number">
                    <img src="./images/add.png" @click="addCart(setPairDialog.item)"/>
                  </div>
                  <div class="addCart"  @click="addCart(setPairDialog.item)" v-if="!setPairDialog.item.number">加入购物车</div>
              </div>
          </div>
          <div class="detailsDialogClose" @click="setPairDialog.show = false">
            <img src="./images/close.png"/>
          </div>
        </van-dialog>
    </div>
        <!-- 开发环境版本，包含了有帮助的命令行警告 -->
        <script src="../backend/plugins/vue/vue.js"></script>
        <!-- 引入组件库 -->
        <script src="../backend/plugins/element-ui/index.js"></script>
        <!-- 引入vant样式 -->
        <script src="./js/vant.min.js"></script>        
        <!-- 引入axios -->
        <script src="../backend/plugins/axios/axios.min.js"></script>
        <script src="./js/request.js"></script>
        <script src="./js/common.js"></script>
        <script src="./api/main.js"></script>
  </body>
  <script>
      new Vue({
          el:'#main',
          data(){
            return {
              //左边菜品类别index
              activeType:0,
              categoryList:[],
              categoryId:undefined,
              petList:[],
              cartData:[],
              dialogDetail:{
                name:'',
                details:[],
                petId:undefined,
                price:undefined,
                show:false,
                image:''
              },
              cartDialogShow:false,
              detailsDialog:{
                show:false,
                item:{image:''}
              },
              setPairDialog:{
                show:false,
                item:{}
              },
            }
          },
          computed:{
            goodsNum(){
              let num = 0
              this.cartData.forEach(item=>{
                num += item.number 
              })
              if(num <99){
                return num
              }else{
                return '99+'
              }
            },
            goodsPrice(){
              let price = 0
              this.cartData.forEach(item=>{
                price += (item.number * item.amount)
              })
              return price
            }
          },
          created(){
          },
          watch:{
            'dialogDetail.show'(flag){
              if(flag){
                document.querySelector('.divCart').style.zIndex = 1
              }else{
                document.querySelector('.divCart').style.zIndex = 3000
              }
            },
          },
          mounted(){
            this.initData()
          },
          methods:{
            //初始化数据
            initData(){
              Promise.all([categoryListApi(),cartListApi({})]).then(res=>{
                //获取分类数据
                if(res[0].code === 1){
                  this.categoryList = res[0].data
                  if(Array.isArray(res[0].data) && res[0].data.length > 0){
                    this.categoryId = res[0].data[0].id
                    if(res[0].data[0].type === 1){
                      this.getPetList()
                    }else{
                      this.getBondpairData()
                    }
                  }
                }else{
                  this.$notify({ type:'warning', message:res[0].msg});
                }
                //获取菜品数据
                if(res[1].code === 1){
                this.cartData = res[1].data
                }else{
                  this.$notify({ type:'warning', message:res[1].msg});
                }
              })
            },
            //分类点击
            categoryClick(index,id,type){
              this.activeType = index
              this.categoryId = id
              if(type === 1){//菜品
                this.getPetList()
              }else{
                this.getBondpairData()
              }
            },
            //获取菜品数据
            async getPetList(){
              if(!this.categoryId){
                return
              }
              const res = await petListApi({categoryId:this.categoryId,status:1})
              if(res.code === 1){
                let petList = res.data
                const cartData  = this.cartData
                if(petList.length > 0 && cartData.length > 0){
                  petList.forEach(pet=>{
                    cartData.forEach(cart=>{
                      if(pet.id === cart.petId){
                        pet.number = cart.number
                      }
                    })
                  })
                }
                this.petList = petList
              }else{
                this.$notify({ type:'warning', message:res.msg});
              }
            },
            //获取套餐数据bondpairId
            async getBondpairData(){
              if(!this.categoryId){
                return
              }
              const res = await bondpairListApi({categoryId:this.categoryId,status:1})
              if(res.code === 1){
                  let petList = res.data
                  const cartData  = this.cartData
                  if(petList.length > 0 && cartData.length > 0){
                    petList.forEach(pet=>{
                      cartData.forEach(cart=>{
                        if(pet.id === cart.bondpairId){
                          pet.number = cart.number
                        }
                      })
                    })
                  }
                  this.petList = petList
              }else{
                this.$notify({ type:'warning', message:res.msg});
              }
            },
            //获取购物车数据
            async getCartData(){
              const res = await cartListApi({})
              if(res.code === 1){
                this.cartData = res.data
              }else{
                this.$notify({ type:'warning', message:res.msg});
              }
            },
            //菜单中往购物车中添加商品
            async addCart(item){
              let params = {
                amount:item.price/100,//金额
                petDetail:item.petDetail,//口味  如果没有传undefined
                petId:undefined,//菜品id
                bondpairId:undefined,//套餐id
                name:item.name,
                image:item.image
              }
              if(Array.isArray(item.details)){//表示是菜品
                params.petId = item.id
              }else{//表示套餐 套餐没有口味
                params.bondpairId = item.id
              }
              const res = await addCartApi(params)
              if(res.code === 1){
                this.petList.forEach(pet=>{
                  if(pet.id === item.id){
                    pet.number = res.data.number
                  }
                })
                if(this.setPairDialog.show){
                  item.number = res.data.number
                }
                this.getCartData()
              }else{
                this.$notify({ type:'warning', message:res.msg});
              }
            },

            //菜单中减少选中的商品
            async subtractCart(item){
                let params = {
                  petId:item.id,
                }
                if(!Array.isArray(item.details)){
                  params = {
                    bondpairId:item.id,
                  }
                }
                const res = await updateCartApi(params)
                if(res.code === 1){
                this.petList.forEach(pet=>{
                  if(pet.id === item.id){
                    pet.number = (res.data.number === 0 ? undefined : res.data.number)
                  }
                })
                if(this.setPairDialog.show){
                  item.number = (res.data.number === 0 ? undefined : res.data.number)
                }
                this.getCartData()
                }else{
                  this.$notify({ type:'warning', message:res.msg});
                }
            },
            
            //展开购物车
            openCart(){
              if(this.cartData.length > 0){
                this.cartDialogShow = true
              }
            },
            //购物车中增加商品数量
            async cartNumAdd(item){
              let params = {
                amount:item.amount,//金额
                petDetail:item.petDetail,//口味  如果没有传undefined
                petId:item.petId,//菜品id
                bondpairId:item.bondpairId,//套餐id
                name:item.name,
                image:item.image
              }
              const res = await addCartApi(params)
              if(res.code === 1){
                this.petList.forEach(pet=>{
                  if(pet.id === (item.petId || item.bondpairId)){
                    pet.number = res.data.number
                  }
                })
                console.log(this.petList)
                this.getCartData()
              }else{
                this.$notify({ type:'warning', message:res.msg});
              }
            },
            //购物车中减少商品数量
            async cartNumberSubtract(item){
              let params = {
                  petId:item.petId,
                  bondpairId:item.bondpairId,
                }
                const res = await updateCartApi(params)
                if(res.code === 1){
                this.petList.forEach(pet=>{
                  if(pet.id === (item.petId || item.bondpairId)){
                    pet.number = (res.data.number === 0 ? undefined : res.data.number)
                  }
                })
                this.getCartData()
                }else{
                  this.$notify({ type:'warning', message:res.msg});
                }
            },
            
            //修改商品列表中的数据number
            changePetList(item){
              for(let ele of this.petList){
                if(ele.id === (item.bondpairId || item.petId)){
                  ele.number = item.number
                }
              }
            },
            
            //清空购物车
            async clearCart(){
                const res = await clearCartApi()
                if(res.code === 1){
                  for(let ele of this.petList){
                    ele.number = undefined
                  }
                  this.cartData = []
                  this.cartDialogShow = false
                }else{
                  this.$notify({ type:'warning', message:res.msg});
                }
            },
            //点击选择规格
            chooseDetailClick(item){
              this.dialogDetail = {
                name:'',
                details:[],
                petId:undefined,
                price:undefined,
                show:false
              }
              this.dialogDetail={
                name:item.name,
                details:item.details,
                petId:item.id,
                price:item.price,
                show:true,
                image:item.image
              }
            },
            detailClick(detail,item){
              detail.petDetail = item
              //强制刷新dialog的dom
              this.dialogDetail.show = false
              this.dialogDetail.show = true
            },
            //选择规格加入购物车
            dialogDetailAddCart(){
              const dialogDetail = this.dialogDetail
              let flag = true
              let petDetail = []
              dialogDetail.details.forEach(item=>{
                if(item.petDetail){
                  petDetail.push(item.petDetail)
                }else{
                      flag = false
                      Notify({ type: 'warning', message: '请选择'+ item.name });
                }
              })
              if(flag){
                this.addCart({
                  price:dialogDetail.price,
                  petDetail:petDetail.join(","),
                  id:dialogDetail.petId,
                  details:[],
                  image:dialogDetail.image,
                  name:dialogDetail.name
                })
                this.dialogDetail.show = false
              }
              
            },
            //网络图片路径转换
            imgPathConvert(path){
              return imgPath(path)
            },
            //跳转到去结算界面
            toAddOrderPage(){
              if(this.cartData.length > 0){
                window.requestAnimationFrame(()=>{
                  window.location.href ='/front/page/add-order.html'
                })
              }
            },
            toUserPage(){
              window.requestAnimationFrame(()=>{
                window.location.href= '/front/page/user.html'
              })
            },
            async petDetails(item){
              //先清除对象数据，如果不行的话dialog使用v-if
              this.detailsDialog.item = {}
              this.setPairDialog.item = {}
              if(Array.isArray(item.details)){
                this.detailsDialog.item = item
                this.detailsDialog.show = true
              }else{
                //显示套餐的数据
                const res = await setPairPetDetailsApi(item.id)
                if(res.code === 1){
                  this.setPairDialog.item = {...item,list:res.data}
                  this.setPairDialog.show = true
                }else{
                  this.$notify({ type:'warning', message:res.msg});
                }
              }

            }

          }
      })
  </script>
  </html>
